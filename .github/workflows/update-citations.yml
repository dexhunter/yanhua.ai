name: Update aideml Citations

on:
  schedule:
    # Run every 6 hours
    - cron: '0 */6 * * *'
  
  # Allow manual triggering
  workflow_dispatch:
  
  # Run on push to main branch for testing
  push:
    branches: [ main ]

jobs:
  update-citations:
    runs-on: ubuntu-latest
    
    permissions:
      contents: write  # Allow the action to commit changes
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
    
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.11'
        cache: 'pip'
    
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: Display environment info
      run: |
        echo "🔧 Environment Information:"
        echo "  Python version: $(python --version)"
        echo "  Working directory: $(pwd)"
        echo "  Repository: ${{ github.repository }}"
        echo "  Trigger: ${{ github.event_name }}"
        
    - name: Run citation tracker with retry
      env:
        SERPAPI_KEY: ${{ secrets.SERPAPI_KEY }}
      run: |
        echo "🔍 Starting citation tracking for aideml..."
        
        # Try up to 3 times with backoff
        for attempt in {1..3}; do
          echo "Attempt $attempt/3..."
          if python fetch_citations.py; then
            echo "✅ Citation tracking completed successfully"
            break
          else
            if [ $attempt -eq 3 ]; then
              echo "❌ Citation tracking failed after 3 attempts"
              exit 1
            else
              echo "⚠️ Attempt $attempt failed, retrying in 30 seconds..."
              sleep 30
            fi
          fi
        done
    
    - name: Validate JSON output
      run: |
        if [ -f citations_data.json ]; then
          echo "📋 Validating citations_data.json..."
          python -c "import json; json.load(open('citations_data.json')); print('✅ JSON is valid')"
        else
          echo "❌ citations_data.json not found"
          exit 1
        fi
    
    - name: Check for changes
      id: git-check
      run: |
        git diff --exit-code citations_data.json || echo "changed=true" >> $GITHUB_OUTPUT
    
    - name: Show current stats
      run: |
        if [ -f citations_data.json ]; then
          echo "📊 Current Citation Stats:"
          python -c "import json; data=json.load(open('citations_data.json')); print(f'  Total Citations: {data.get(\"total_citations\", 0)}'); print(f'  Recent Citations: {data.get(\"recent_citations\", 0)}'); print(f'  H-Index: {data.get(\"h_index\", 0)}'); print(f'  Papers Found: {len(data.get(\"papers\", []))}'); print(f'  Last Updated: {data.get(\"last_updated\", \"Unknown\")}')"
        fi
    
    - name: Commit and push changes
      if: steps.git-check.outputs.changed == 'true'
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        git add citations_data.json
        git commit -m "🤖 Update aideml citations data - $(date)"
        git push
        echo "✅ Changes pushed - Vercel will auto-deploy the updated data"
    
    - name: Create summary
      run: |
        echo "## 📚 aideml Citation Update Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        
        if [[ -f citations_data.json ]]; then
          total_citations=$(python -c "import json; data=json.load(open('citations_data.json')); print(data.get('total_citations', 0))")
          last_updated=$(python -c "import json; data=json.load(open('citations_data.json')); print(data.get('last_updated', 'Unknown'))")
          
          echo "- **Total Citations Found:** $total_citations" >> $GITHUB_STEP_SUMMARY
          echo "- **Last Updated:** $last_updated" >> $GITHUB_STEP_SUMMARY
          echo "- **Target Paper:** aideml research" >> $GITHUB_STEP_SUMMARY
          
          if [[ "${{ steps.git-check.outputs.changed }}" == "true" ]]; then
            echo "- **Status:** ✅ Data updated successfully" >> $GITHUB_STEP_SUMMARY
            echo "- **Deployment:** 🚀 Vercel will auto-deploy the updated data" >> $GITHUB_STEP_SUMMARY
          else
            echo "- **Status:** ℹ️ No new citations found" >> $GITHUB_STEP_SUMMARY
          fi
        else
          echo "- **Status:** ❌ Failed to generate citation data" >> $GITHUB_STEP_SUMMARY
        fi
        
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "🌐 **Live Website:** Your aideml citation tracker is deployed on Vercel" >> $GITHUB_STEP_SUMMARY
        
        # Add performance info
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "⚡ **Performance Optimizations:**" >> $GITHUB_STEP_SUMMARY
        echo "- Python 3.11 with pip caching for faster builds" >> $GITHUB_STEP_SUMMARY
        echo "- Retry mechanism with 3 attempts for reliability" >> $GITHUB_STEP_SUMMARY
        echo "- JSON validation before deployment" >> $GITHUB_STEP_SUMMARY
        echo "- Vercel CDN for global fast access" >> $GITHUB_STEP_SUMMARY 