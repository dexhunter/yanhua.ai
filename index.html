<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>aideml - Citation Tracker</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        min-height: 100vh;
        color: #333;
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 20px;
      }

      header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
        text-align: center;
      }

      .header-main {
        text-align: center;
        margin-bottom: 20px;
      }

      .header-main h1 {
        color: #2c3e50;
        font-size: 3em;
        margin-bottom: 5px;
        font-weight: 700;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
      }

      .header-subtitle {
        color: #7f8c8d;
        font-size: 1.2em;
        font-weight: 500;
        margin: 0;
      }

      .header-stats {
        display: flex;
        justify-content: center;
        gap: 30px;
        margin-top: 20px;
        flex-wrap: wrap;
      }

      .header-stat {
        display: flex;
        flex-direction: column;
        align-items: center;
        text-align: center;
      }

      .header-stat strong {
        color: #3498db;
        font-size: 1.8em;
        font-weight: 700;
        display: block;
      }

      .header-stat small {
        color: #7f8c8d;
        font-size: 0.9em;
        margin-top: 2px;
      }

      .paper-info {
        background: rgba(52, 152, 219, 0.1);
        padding: 20px;
        border-radius: 15px;
        margin-bottom: 20px;
        border: 2px solid rgba(52, 152, 219, 0.2);
      }

      .paper-info h2 {
        color: #2980b9;
        margin-bottom: 10px;
        font-size: 1.3em;
      }

      .paper-info p {
        line-height: 1.6;
        color: #555;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 20px;
        margin-bottom: 30px;
      }

      .stat-card {
        background: rgba(255, 255, 255, 0.95);
        padding: 25px;
        border-radius: 15px;
        text-align: center;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        transition: transform 0.3s ease, box-shadow 0.3s ease;
      }

      .stat-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(0, 0, 0, 0.2);
      }

      .stat-number {
        font-size: 2.5em;
        font-weight: bold;
        color: #3498db;
        margin-bottom: 10px;
      }

      .stat-label {
        font-size: 1.1em;
        color: #7f8c8d;
      }

      .papers-section {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 20px;
        padding: 30px;
        margin-bottom: 30px;
        box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
      }

      .papers-section h2 {
        color: #2c3e50;
        margin-bottom: 25px;
        font-size: 1.8em;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }

      .paper-card {
        background: #f8f9fa;
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #3498db;
        transition: all 0.3s ease;
      }

      .paper-card:hover {
        transform: translateX(5px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
      }

      .paper-title {
        font-size: 1.2em;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 10px;
        line-height: 1.4;
      }

      .paper-authors {
        color: #7f8c8d;
        margin-bottom: 8px;
        font-style: italic;
      }

      .paper-journal {
        color: #27ae60;
        font-weight: 500;
        margin-bottom: 10px;
      }

      .paper-institutions {
        color: #8e44ad;
        font-weight: 500;
        margin-bottom: 10px;
        background: rgba(142, 68, 173, 0.1);
        padding: 5px 10px;
        border-radius: 5px;
        border-left: 3px solid #8e44ad;
      }

      .paper-snippet {
        color: #555;
        line-height: 1.6;
        margin-bottom: 10px;
      }

      .paper-meta {
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-size: 0.9em;
        color: #7f8c8d;
      }

      .month-section {
        margin-bottom: 40px;
      }

      .month-header {
        background: linear-gradient(135deg, #3498db 0%, #2980b9 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        margin-bottom: 20px;
        font-size: 1.3em;
        font-weight: 600;
        box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
      }

      .month-header .month-count {
        float: right;
        background: rgba(255, 255, 255, 0.2);
        padding: 2px 10px;
        border-radius: 20px;
        font-size: 0.9em;
      }

      .paper-link {
        color: #3498db;
        text-decoration: none;
        font-weight: 500;
      }

      .paper-link:hover {
        text-decoration: underline;
      }

      .update-info {
        background: rgba(46, 204, 113, 0.1);
        border: 2px solid rgba(46, 204, 113, 0.2);
        border-radius: 10px;
        padding: 15px;
        margin-bottom: 20px;
        text-align: center;
      }

      .update-info p {
        color: #27ae60;
        font-weight: 500;
      }

      .loading {
        text-align: center;
        padding: 40px;
        color: #7f8c8d;
      }

      .loading:before {
        content: "üîÑ ";
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }

      .chart-container {
        background: rgba(255, 255, 255, 0.95);
        border-radius: 15px;
        padding: 25px;
        margin-bottom: 30px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
      }

      .chart-container h2 {
        color: #2c3e50;
        margin-bottom: 10px;
        text-align: center;
        font-size: 1.8em;
        border-bottom: 3px solid #3498db;
        padding-bottom: 10px;
      }

      .footer {
        text-align: center;
        padding: 20px;
        color: rgba(255, 255, 255, 0.8);
        background: rgba(0, 0, 0, 0.1);
        border-radius: 10px;
      }

      @media (max-width: 768px) {
        .container {
          padding: 10px;
        }

        .header-main h1 {
          font-size: 2.2em;
        }

        .header-subtitle {
          font-size: 1em;
        }

        .header-stats {
          gap: 20px;
        }

        .header-stat strong {
          font-size: 1.5em;
        }

        .stats-grid {
          grid-template-columns: 1fr;
        }

        .month-header {
          padding: 12px 20px;
          font-size: 1.1em;
        }

        .month-header .month-count {
          float: none;
          display: block;
          margin-top: 5px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <header>
        <div class="header-main">
          <h1>aideml Citation Tracker</h1>
          <p class="header-subtitle">Monitoring the impact of our research paper</p>
        </div>
        <div class="paper-info">
          <h2>üî¨ Tracking Citations For</h2>
          <p>
            This dashboard tracks citations for the paper <strong>"aideml"</strong>, available on arXiv.
            <br>
            <a href="https://www.aide.ml/" target="_blank" class="paper-link">Official Project Website ‚Üí</a>
            <span style="margin: 0 8px;">‚Ä¢</span>
            <a href="https://arxiv.org/abs/2502.13138" target="_blank" class="paper-link">Read the full paper on arXiv ‚Üí</a>
          </p>
          <div class="header-stats">
            <span class="header-stat">
              <strong id="headerTotalCitations">-</strong>
              <small>Total Citations</small>
            </span>
            <span class="header-stat">
              <strong id="headerRecentCitations">-</strong>
              <small>This Month</small>
            </span>
            <span class="header-stat">
              <strong id="headerHIndex">-</strong>
              <small>H-Index</small>
            </span>
          </div>
        </div>
      </header>

      <div class="update-info">
        <p>‚ö° Last updated: <span id="lastUpdated">Loading...</span></p>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-number" id="totalCitations">-</div>
          <div class="stat-label">Total Citations</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="recentCitations">-</div>
          <div class="stat-label">Recent Citations (30 days)</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="avgCitationsPerMonth">-</div>
          <div class="stat-label">Avg. Citations/Month</div>
        </div>
        <div class="stat-card">
          <div class="stat-number" id="hIndex">-</div>
          <div class="stat-label">H-Index Impact</div>
        </div>
      </div>

      <div class="papers-section">
        <h2>üìÑ Citing Papers</h2>
        <div id="papersContainer">
          <div class="loading">Loading citing papers...</div>
        </div>
      </div>

              <div class="chart-container">
            <h2>üìà Citation Growth Timeline</h2>
            <p style="color: #7f8c8d; margin-bottom: 20px; text-align: center">
                Cumulative citations over time based on exact publication dates (YYYY-MM-DD format)
            </p>
            <canvas id="citationsChart"></canvas>
        </div>

      <div class="footer">
        <p>
          ü§ñ Automated citation tracking powered by SerpAPI and GitHub Actions
        </p>
        <p>Updated daily ‚Ä¢ Data source: Google Scholar ‚Ä¢ Deployed on Cloudflare</p>
      </div>
    </div>

    <script>
      // Initialize chart
      const ctx = document.getElementById("citationsChart").getContext("2d");
      let citationsChart;

      // Load data from the API endpoint
      async function loadData() {
        try {
          const response = await fetch("/api/citations"); // This will be routed by the Cloudflare Worker
          const data = await response.json();

          if (data.error) {
            document.getElementById(
              "papersContainer"
            ).innerHTML = `<div class="loading">‚ö†Ô∏è ${data.error}</div>`;
            return;
          }

          // Update statistics (both main stats and header stats)
          document.getElementById("totalCitations").textContent =
            data.total_citations || 0;
          document.getElementById("recentCitations").textContent =
            data.recent_citations || 0;
          document.getElementById("avgCitationsPerMonth").textContent =
            data.avg_citations_per_month || 0;
          document.getElementById("hIndex").textContent = data.h_index || 0;
          document.getElementById("lastUpdated").textContent =
            data.last_updated || "Never";

          // Update header stats
          document.getElementById("headerTotalCitations").textContent =
            data.total_citations || 0;
          document.getElementById("headerRecentCitations").textContent =
            data.recent_citations || 0;
          document.getElementById("headerHIndex").textContent =
            data.h_index || 0;

          // Render papers
          renderPapers(data.papers || []);

          // Update chart
          updateChart(data.timeline || []);
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById("papersContainer").innerHTML =
            '<div class="loading">‚ö†Ô∏è Error loading citation data</div>';
        }
      }

      function renderPapers(papers) {
        const container = document.getElementById("papersContainer");

        if (papers.length === 0) {
          container.innerHTML =
            '<div class="loading">üì≠ No citing papers found yet</div>';
          return;
        }

        // Group papers by publication month
        const papersByMonth = {};
        papers.forEach((paper) => {
          const monthKey = extractMonthYear(paper.published_date);
          if (!papersByMonth[monthKey]) {
            papersByMonth[monthKey] = [];
          }
          papersByMonth[monthKey].push(paper);
        });

        // Sort months (newest first)
        const sortedMonths = Object.keys(papersByMonth).sort((a, b) => {
          const dateA = parseMonthYear(a);
          const dateB = parseMonthYear(b);
          return dateB - dateA;
        });

        // Render monthly sections
        container.innerHTML = sortedMonths
          .map((month) => {
            const monthPapers = papersByMonth[month];
            return `
                    <div class="month-section">
                        <div class="month-header">
                            üìÖ ${month}
                            <span class="month-count">${
                              monthPapers.length
                            } paper${monthPapers.length !== 1 ? "s" : ""}</span>
                        </div>
                        ${monthPapers
                          .map(
                            (paper) => `
                            <div class="paper-card">
                                <div class="paper-title">${escapeHtml(
                                  paper.title || "Untitled"
                                )}</div>
                                <div class="paper-authors">${escapeHtml(
                                  paper.authors || "Unknown authors"
                                )}</div>
                                <div class="paper-journal">${escapeHtml(
                                  paper.journal || "Unknown journal"
                                )}</div>
                                ${paper.institutions && paper.institutions !== "Unknown" ? `<div class="paper-institutions">üèõÔ∏è ${escapeHtml(paper.institutions)}</div>` : ''}
                                <div class="paper-snippet">${escapeHtml(
                                  paper.snippet || "No snippet available"
                                )}</div>
                                <div class="paper-meta">
                                    <span>Published: ${
                                      paper.published_date || "Unknown"
                                    }</span>
                                    <a href="${
                                      paper.link
                                    }" target="_blank" class="paper-link">View Paper ‚Üí</a>
                                </div>
                            </div>
                        `
                          )
                          .join("")}
                    </div>
                `;
          })
          .join("");
      }

              function extractMonthYear(dateString) {
            if (!dateString || dateString === "Unknown" || dateString === "1900-01-01") return "Unknown";

            // Handle "YYYY-MM-DD" format 
            const isoDateMatch = dateString.match(/^(\d{4})-(\d{2})-(\d{2})$/);
            if (isoDateMatch) {
                const year = isoDateMatch[1];
                const month = isoDateMatch[2];
                const monthNames = {
                    '01': 'January', '02': 'February', '03': 'March', '04': 'April',
                    '05': 'May', '06': 'June', '07': 'July', '08': 'August',
                    '09': 'September', '10': 'October', '11': 'November', '12': 'December'
                };
                return `${monthNames[month]} ${year}`;
            }

            // Handle "Month Year" format (legacy support)
            const monthYearMatch = dateString.match(/([A-Za-z]+)\s+(\d{4})/);
            if (monthYearMatch) {
                return `${monthYearMatch[1]} ${monthYearMatch[2]}`;
            }

            // Handle just year (e.g., "2025")
            const yearMatch = dateString.match(/(\d{4})/);
            if (yearMatch) {
                return yearMatch[1];
            }

            return dateString;
        }

      function parseMonthYear(monthYearString) {
        if (monthYearString === "Unknown") return new Date(1900, 0);

        const monthMap = {
          january: 0,
          february: 1,
          march: 2,
          april: 3,
          may: 4,
          june: 5,
          july: 6,
          august: 7,
          september: 8,
          october: 9,
          november: 10,
          december: 11,
        };

        // Handle "Month Year" format
        const parts = monthYearString.toLowerCase().split(" ");
        if (parts.length === 2) {
          const month = monthMap[parts[0]] || 0;
          const year = parseInt(parts[1]) || 2000;
          return new Date(year, month);
        }

        // Handle just year
        const year = parseInt(monthYearString) || 2000;
        return new Date(year, 0);
      }

              function updateChart(timeline) {
            if (citationsChart) {
                citationsChart.destroy();
            }

            // The data is now in a format Chart.js can use directly with the time adapter
            const chartData = timeline.map(item => ({
                x: item.date,
                y: item.citations
            }));

            citationsChart = new Chart(ctx, {
                type: "line",
                data: {
                    datasets: [
                        {
                            label: "Cumulative Citations",
                            data: chartData,
                            borderColor: "#3498db",
                            backgroundColor: "rgba(52, 152, 219, 0.2)",
                            borderWidth: 3,
                            fill: true,
                            tension: 0.2,
                            pointBackgroundColor: "#3498db",
                            pointBorderColor: "#ffffff",
                            pointBorderWidth: 2,
                            pointRadius: 5,
                            pointHoverRadius: 7,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            display: true,
                            position: "top",
                            labels: {
                                color: "#2c3e50",
                                font: {
                                    size: 14,
                                    weight: "500",
                                },
                            },
                        },
                        tooltip: {
                            backgroundColor: "rgba(44, 62, 80, 0.9)",
                            titleColor: "#ffffff",
                            bodyColor: "#ffffff",
                            borderColor: "#3498db",
                            borderWidth: 1,
                            callbacks: {
                                label: function(context) {
                                    return `Total Citations: ${context.raw.y}`;
                                },
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                precision: 0,
                                color: "#7f8c8d",
                            },
                            grid: {
                                color: "rgba(127, 140, 141, 0.1)",
                            },
                            title: {
                                display: true,
                                text: "Cumulative Citations",
                                color: "#2c3e50",
                                font: {
                                    size: 12,
                                    weight: "500",
                                },
                            },
                        },
                        x: {
                            type: 'time',
                            time: {
                                unit: 'month',
                                tooltipFormat: 'MMM dd, yyyy',
                                displayFormats: {
                                    month: 'MMM yyyy'
                                }
                            },
                            ticks: {
                                color: "#7f8c8d",
                            },
                            grid: {
                                color: "rgba(127, 140, 141, 0.1)",
                            },
                            title: {
                                display: true,
                                text: "Publication Date",
                                color: "#2c3e50",
                                font: {
                                    size: 12,
                                    weight: "500",
                                },
                            },
                        },
                    },
                },
            });
        }

      function escapeHtml(text) {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
      }

      // Load data when page loads
      document.addEventListener("DOMContentLoaded", loadData);

      // Refresh data every 30 seconds
      setInterval(loadData, 30000);
    </script>
  </body>
</html>
